name: Deploy iOS SDK Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.3)'
        required: true
        type: string
      release_notes:
        description: 'Release notes (leave empty for auto-generation from git log)'
        required: false
        type: string
      artifact_source:
        description: 'Where to get artifact from'
        required: true
        type: choice
        options:
          - 'build_workflow'
          - 'github_release'
          - 'upload_manually'
        default: 'build_workflow'
      build_run_id:
        description: 'Build workflow run ID (if artifact_source is build_workflow). Leave empty to use latest successful run.'
        required: false
        type: string
      skip_distribution_repo:
        description: 'Skip updating distribution repository (only create GitHub Release)'
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    runs-on: macos-26
    timeout-minutes: 60
    
    steps:
      - name: Validate version format
        run: |
          VERSION="${{ inputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Error: Invalid version format. Expected format: X.Y.Z (e.g., 1.0.3)"
            exit 1
          fi
          echo "âœ… Version format is valid: $VERSION"
      
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for release notes generation

      - name: Find latest build workflow run
        if: inputs.artifact_source == 'build_workflow' && inputs.build_run_id == ''
        id: find_build_run
        uses: actions/github-script@v7
        with:
          script: |
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ios-sdk-ci.yml',
              status: 'success',
              per_page: 1
            });
            
            if (runs.workflow_runs.length === 0) {
              core.setFailed('No successful build workflow runs found');
              return;
            }
            
            const runId = runs.workflow_runs[0].id;
            console.log(`Found latest successful run: ${runId}`);
            core.setOutput('run_id', runId);

      - name: Download artifact from build workflow
        if: inputs.artifact_source == 'build_workflow'
        uses: actions/download-artifact@v4
        with:
          name: ios-sdk-xcframework
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ inputs.build_run_id != '' && inputs.build_run_id || steps.find_build_run.outputs.run_id }}
          path: ./artifacts

      - name: Download artifact from GitHub Release
        if: inputs.artifact_source == 'github_release'
        run: |
          # Install gh CLI if not available
          if ! command -v gh &> /dev/null; then
            echo "Installing gh CLI..."
            brew install gh || echo "gh CLI installation failed, trying alternative method"
          fi
          
          # Authenticate
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          
          # Download release assets
          TAG="v${{ inputs.version }}"
          echo "Downloading artifacts from release $TAG..."
          
          mkdir -p ./artifacts
          
          # Try distribution repo first
          if [ -n "${{ secrets.DISTRIBUTION_REPO }}" ]; then
            echo "Trying to download from distribution repository: ${{ secrets.DISTRIBUTION_REPO }}"
            gh release download "$TAG" \
              --repo ${{ secrets.DISTRIBUTION_REPO }} \
              --pattern "*.zip" \
              --dir ./artifacts || {
                echo "Failed to download from distribution repo, trying current repo..."
                # Try downloading from current repo if distribution repo doesn't have it
                gh release download "$TAG" \
                  --pattern "*.zip" \
                  --dir ./artifacts || {
                    echo "âŒ Failed to download from both repositories"
                    exit 1
                  }
              }
          else
            # Try current repo
            echo "Downloading from current repository..."
            gh release download "$TAG" \
              --pattern "*.zip" \
              --dir ./artifacts || {
                echo "âŒ Failed to download release artifacts"
                exit 1
              }
          fi
          
          echo "âœ… Artifacts downloaded:"
          ls -lh ./artifacts/
      
      - name: Wait for manual artifact upload
        if: inputs.artifact_source == 'upload_manually'
        run: |
          echo "â³ Waiting for manual artifact upload..."
          echo "Please upload the artifact to ./artifacts/ directory"
          echo "Expected files:"
          echo "  - AriseMobile-v${{ inputs.version }}-xcframeworks.zip"
          echo "  - Or extracted libs/ directory with AriseMobile.xcframework"
          echo ""
          echo "Press Enter after uploading artifacts, or wait 60 seconds for timeout..."
          
          # Wait for artifacts to appear
          timeout=60
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if [ -d "./artifacts" ] && [ -n "$(ls -A ./artifacts 2>/dev/null)" ]; then
              echo "âœ… Artifacts found!"
              break
            fi
            sleep 2
            elapsed=$((elapsed + 2))
            echo "   Waiting... ($elapsed/$timeout seconds)"
          done
          
          if [ $elapsed -ge $timeout ]; then
            echo "âš ï¸  Timeout waiting for artifacts. Please ensure artifacts are uploaded."
          fi

      - name: Verify artifact exists
        run: |
          if [ ! -d "./artifacts" ] || [ -z "$(ls -A ./artifacts 2>/dev/null)" ]; then
            echo "âŒ Error: No artifacts found!"
            echo "Available artifacts:"
            ls -la ./artifacts/ 2>/dev/null || echo "artifacts directory does not exist"
            exit 1
          fi
          
          echo "âœ… Artifacts found:"
          ls -lh ./artifacts/
          
          # Verify expected files exist
          ZIP_FILE=$(find ./artifacts -name "AriseMobile-v${{ inputs.version }}-xcframeworks.zip" -o -name "*.zip" | head -1)
          FRAMEWORK_DIR=$(find ./artifacts -type d -name "AriseMobile.xcframework" | head -1)
          
          if [ -z "$ZIP_FILE" ] && [ -z "$FRAMEWORK_DIR" ]; then
            echo "âš ï¸  Warning: Expected artifact files not found"
            echo "Looking for:"
            echo "  - AriseMobile-v${{ inputs.version }}-xcframeworks.zip"
            echo "  - Or AriseMobile.xcframework directory"
            echo ""
            echo "Found files:"
            find ./artifacts -type f -o -type d | head -10
          else
            if [ -n "$ZIP_FILE" ]; then
              echo "âœ… Found ZIP archive: $ZIP_FILE"
            fi
            if [ -n "$FRAMEWORK_DIR" ]; then
              echo "âœ… Found framework directory: $FRAMEWORK_DIR"
            fi
          fi

      - name: Generate release notes
        id: release_notes
        run: |
          if [ -n "${{ inputs.release_notes }}" ]; then
            # Use manually provided release notes
            NOTES="${{ inputs.release_notes }}"
            echo "âœ… Using manually provided release notes"
          else
            # Auto-generate from git log
            TAG="v${{ inputs.version }}"
            echo "ðŸ“ Auto-generating release notes for $TAG..."
            
            PREV_TAG=$(git describe --tags --abbrev=0 --exclude="$TAG" 2>/dev/null || echo "")
            
            if [ -z "$PREV_TAG" ]; then
              # No previous tag found, generate initial release notes
              NOTES="## ðŸš€ AriseMobileSdk $TAG"$'\n\n'
              NOTES+="### ðŸ“¦ Initial Release"$'\n\n'
              NOTES+="First release of AriseMobileSdk."$'\n\n'
              NOTES+="### ðŸ“‹ Technical Details"$'\n\n'
              NOTES+="- **Minimum iOS version:** 15.0"$'\n'
              NOTES+="- **Minimum Xcode version:** 15.0"$'\n'
              NOTES+="- **Minimum Swift version:** 5.9"$'\n\n'
              NOTES+="### ðŸ“¥ Installation"$'\n\n'
              NOTES+='```swift'$'\n'
              NOTES+="dependencies: ["$'\n'
              NOTES+="    .package("$'\n'
              NOTES+='        url: "https://github.com/${{ secrets.DISTRIBUTION_REPO }}.git",'$'\n'
              NOTES+="        from: \"${{ inputs.version }}\""$'\n'
              NOTES+="    )"$'\n'
              NOTES+="]"$'\n'
              NOTES+='```'
            else
              # Generate notes from git log between tags
              # Get commits between tags
              COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges 2>/dev/null || echo "")
              
              if [ -z "$COMMITS" ]; then
                COMMITS_TEXT="No commits found between $PREV_TAG and HEAD."
              else
                COMMITS_TEXT="$COMMITS"
              fi
              
              NOTES="## ðŸš€ AriseMobileSdk $TAG"$'\n\n'
              NOTES+="### ðŸ“¦ What's New"$'\n\n'
              NOTES+="Changes since $PREV_TAG:"$'\n\n'
              NOTES+="$COMMITS_TEXT"$'\n\n'
              NOTES+="### ðŸ“‹ Technical Details"$'\n\n'
              NOTES+="- **Minimum iOS version:** 15.0"$'\n'
              NOTES+="- **Minimum Xcode version:** 15.0"$'\n'
              NOTES+="- **Minimum Swift version:** 5.9"$'\n\n'
              NOTES+="### ðŸ“¥ Installation"$'\n\n'
              NOTES+='```swift'$'\n'
              NOTES+="dependencies: ["$'\n'
              NOTES+="    .package("$'\n'
              NOTES+='        url: "https://github.com/${{ secrets.DISTRIBUTION_REPO }}.git",'$'\n'
              NOTES+="        from: \"${{ inputs.version }}\""$'\n'
              NOTES+="    )"$'\n'
              NOTES+="]"$'\n'
              NOTES+='```'
            fi
            
            echo "âœ… Release notes generated"
          fi
          
          # Output release notes
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ðŸ“„ Generated release notes:"
          echo "---"
          echo "$NOTES"
          echo "---"

      - name: Prepare distribution package
        if: inputs.skip_distribution_repo == false
        run: |
          echo "ðŸ“¦ Preparing distribution package..."
          
          # Extract ZIP if needed
          ZIP_FILE=$(find ./artifacts -name "*.zip" | head -1)
          if [ -n "$ZIP_FILE" ]; then
            echo "Extracting ZIP archive: $ZIP_FILE"
            unzip -q "$ZIP_FILE" -d ./artifacts-extracted || {
              echo "âš ï¸  Failed to extract ZIP, trying to use as-is"
            }
            
            # Check if extraction was successful
            if [ -d "./artifacts-extracted/libs" ]; then
              echo "âœ… Extracted libs directory found"
              mkdir -p ./distribution-package
              cp -R ./artifacts-extracted/libs ./distribution-package/
            fi
          fi
          
          # Copy framework if it exists directly
          FRAMEWORK_DIR=$(find ./artifacts -type d -name "AriseMobile.xcframework" | head -1)
          if [ -n "$FRAMEWORK_DIR" ]; then
            echo "âœ… Found framework directory: $FRAMEWORK_DIR"
            mkdir -p ./distribution-package/libs
            cp -R "$FRAMEWORK_DIR" ./distribution-package/libs/ || true
          fi
          
          # Copy Package.swift and Sources if they exist in artifacts
          if [ -f "./artifacts/Package.swift" ]; then
            cp ./artifacts/Package.swift ./distribution-package/
          fi
          if [ -d "./artifacts/Sources" ]; then
            cp -R ./artifacts/Sources ./distribution-package/
          fi
          
          echo "âœ… Distribution package prepared"
          ls -lh ./distribution-package/ 2>/dev/null || echo "Distribution package directory structure:"
          find ./distribution-package -type f -o -type d | head -20 || true

      - name: Checkout distribution repository
        if: inputs.skip_distribution_repo == false
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.DISTRIBUTION_REPO }}
          token: ${{ secrets.DISTRIBUTION_REPO_TOKEN }}
          path: distribution-repo
          fetch-depth: 0

      - name: Configure git for distribution repo
        if: inputs.skip_distribution_repo == false
        working-directory: distribution-repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check if tag already exists
        id: check_tag
        run: |
          TAG="v${{ inputs.version }}"
          
          if [ "${{ inputs.skip_distribution_repo }}" == "false" ]; then
            # Check in distribution repository
            if git -C distribution-repo rev-parse "$TAG" >/dev/null 2>&1; then
              echo "exists=true" >> $GITHUB_OUTPUT
              echo "âš ï¸  Tag $TAG already exists in distribution repository"
            else
              echo "exists=false" >> $GITHUB_OUTPUT
              echo "âœ… Tag $TAG does not exist in distribution repository"
            fi
          else
            # Check in current repository
            if git rev-parse "$TAG" >/dev/null 2>&1; then
              echo "exists=true" >> $GITHUB_OUTPUT
              echo "âš ï¸  Tag $TAG already exists in current repository"
            else
              echo "exists=false" >> $GITHUB_OUTPUT
              echo "âœ… Tag $TAG does not exist in current repository"
            fi
          fi

      - name: Update distribution repository
        if: inputs.skip_distribution_repo == false && steps.check_tag.outputs.exists == 'false'
        run: |
          echo "ðŸ“ Updating distribution repository..."
          
          # Copy files to distribution repository
          if [ -d "./distribution-package" ]; then
            # Copy Package.swift if exists
            if [ -f "./distribution-package/Package.swift" ]; then
              cp ./distribution-package/Package.swift distribution-repo/
            fi
            
            # Copy Sources if exists
            if [ -d "./distribution-package/Sources" ]; then
              mkdir -p distribution-repo/Sources
              cp -R ./distribution-package/Sources/* distribution-repo/Sources/
            fi
            
            # Copy libs
            if [ -d "./distribution-package/libs" ]; then
              mkdir -p distribution-repo/libs
              rm -rf distribution-repo/libs/*
              cp -R ./distribution-package/libs/* distribution-repo/libs/
            fi
          else
            # Fallback: copy from artifacts directly
            if [ -d "./artifacts/libs" ]; then
              mkdir -p distribution-repo/libs
              cp -R ./artifacts/libs/* distribution-repo/libs/
            fi
          fi
          
          # Copy Package.swift and Sources from source if not in artifacts
          if [ ! -f "distribution-repo/Package.swift" ]; then
            if [ -f "ios-sdk/Distribution/Package.swift" ]; then
              cp ios-sdk/Distribution/Package.swift distribution-repo/
            fi
          fi
          
          if [ ! -d "distribution-repo/Sources" ]; then
            if [ -d "ios-sdk/Distribution/Sources" ]; then
              mkdir -p distribution-repo/Sources
              cp -R ios-sdk/Distribution/Sources/* distribution-repo/Sources/
            fi
          fi
          
          echo "âœ… Files copied to distribution repository"

      - name: Commit and push to distribution repository
        if: inputs.skip_distribution_repo == false && steps.check_tag.outputs.exists == 'false'
        working-directory: distribution-repo
        run: |
          git checkout main || git checkout -b main
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Release version ${{ inputs.version }}"
            git push origin main || git push -u origin main
            echo "âœ… Changes pushed to distribution repository"
          fi

      - name: Create git tag in distribution repository
        if: inputs.skip_distribution_repo == false && steps.check_tag.outputs.exists == 'false'
        working-directory: distribution-repo
        run: |
          TAG="v${{ inputs.version }}"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
          echo "âœ… Tag $TAG created and pushed to distribution repository"

      - name: Prepare release artifacts
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          echo "ðŸ“¦ Preparing release artifacts..."
          mkdir -p ./release-artifacts
          
          # Find and copy ZIP file
          ZIP_FILE=$(find ./artifacts -name "*.zip" | head -1)
          if [ -n "$ZIP_FILE" ]; then
            cp "$ZIP_FILE" ./release-artifacts/
            echo "âœ… Copied ZIP file: $(basename "$ZIP_FILE")"
          else
            # Create ZIP from framework if no ZIP exists
            FRAMEWORK_DIR=$(find ./artifacts -type d -name "AriseMobile.xcframework" | head -1)
            if [ -n "$FRAMEWORK_DIR" ]; then
              echo "Creating ZIP from framework..."
              cd "$(dirname "$FRAMEWORK_DIR")"
              zip -r "../../release-artifacts/AriseMobile-v${{ inputs.version }}-xcframeworks.zip" "$(basename "$FRAMEWORK_DIR")" || {
                cd - && mkdir -p libs && cp -R "$FRAMEWORK_DIR" libs/ && zip -r "../release-artifacts/AriseMobile-v${{ inputs.version }}-xcframeworks.zip" libs/
              }
              cd - || true
              echo "âœ… Created ZIP archive"
            fi
          fi
          
          echo "ðŸ“¦ Release artifacts prepared:"
          ls -lh ./release-artifacts/

      - name: Create GitHub Release
        if: steps.check_tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          repository: ${{ secrets.DISTRIBUTION_REPO }}
          token: ${{ secrets.DISTRIBUTION_REPO_TOKEN }}
          tag_name: v${{ inputs.version }}
          name: AriseMobileSdk v${{ inputs.version }}
          body: ${{ steps.release_notes.outputs.notes }}
          files: ./release-artifacts/*
          draft: false
          prerelease: false

      - name: Summary
        if: always()
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** \`${{ inputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** \`v${{ inputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact Source:** \`${{ inputs.artifact_source }}\`" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.skip_distribution_repo }}" == "true" ]; then
            echo "- **Distribution Repo:** â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Distribution Repo:** âœ… Updated" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_tag.outputs.exists }}" == "true" ]; then
            echo "### âš ï¸ Status: Tag Already Exists" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The tag \`v${{ inputs.version }}\` already exists. Release was skipped." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… Status: Release Created Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Release \`v${{ inputs.version }}\` has been created and published." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¦ Installation" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`swift" >> $GITHUB_STEP_SUMMARY
            echo "dependencies: [" >> $GITHUB_STEP_SUMMARY
            echo "    .package(" >> $GITHUB_STEP_SUMMARY
            echo "        url: \"https://github.com/${{ secrets.DISTRIBUTION_REPO }}.git\"," >> $GITHUB_STEP_SUMMARY
            echo "        from: \"${{ inputs.version }}\"" >> $GITHUB_STEP_SUMMARY
            echo "    )" >> $GITHUB_STEP_SUMMARY
            echo "]" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

